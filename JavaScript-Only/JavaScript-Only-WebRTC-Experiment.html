<!--
    *  Muaz Khan
    *  @muazkh:  http://twitter.com/muazkh
    *  Github:   github.com/muaz-khan
-->
<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta itemprop="image" content="https://muazkh.appspot.com/images/WebRTC.png">

    <title>(Pubnub/JavaScript) WebRTC Experiment ® Muaz Khan</title>
    <meta name="description" content="WebRTC Experiment that uses Pubnub for signaling to make a realtime handshake! It is reliable and faster as compare to traditional XHR model!

    You can say it JavaScript only WebRTC Experiment because you don't need to understand any server side language or technology. Just JavaScript knowledge is enough!">
    
    <link rel="author" type="text/html" href="https://plus.google.com/100325991024054712503">
    <meta name="author" content="Muaz Khan">
    <meta name="copyright" content="© Muaz Khan, {year}">

    <link href= "//fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: 'Open Sans';
            -moz-transition: all .8s ease;
            -ms-transition: all .8s ease;
            -o-transition: all .8s ease;
            -webkit-transition: all .8s ease;
        }
        html
        {
            background: #ECECEC;
            overflow-x:hidden;
        }

        body {
            color: #333;
            font: 1.4em 'Open Sans', arial, sans-serif;
            font-weight: 300;
            line-height: 1.5;
            margin: 0 3em;
        }

        h1, h2 {
            color: #2778ec;
            font-size: 1.6em;
            font-weight: 300;
            line-height: 1.15;
        }

        .logo img
        {
            border-radius: 50%; 
            box-shadow: 0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black;
        }

        blockquote
        {
            margin-bottom: 1em;
        }
        #public-rooms blockquote
        {
            border: 1px solid #FF4010;
            padding: 1em 2em;
            margin-top: 1em;
            background: #FDF3BC;
        }
        table
        {
            background: rgba(255, 255, 255, 0.76);
        }
        tr, td
        {
            vertical-align: top;
            padding: .7em 1.4em;
        }
        .center-table td
        {
            width:40%;
        }

        @media screen and (max-width: 770px) {
            body { margin: 0 .1em;font-size: 1em; }
            tr, td{padding: .1em .4em;}
        }

        a
        {
            display: inline-block;
            padding: 0.2em;
            padding-left: 1.5em;
            background: url(https://webrtc-experiment.appspot.com/images/right-arrow-hover.png) no-repeat left center;
            color: #1B75C9;
            text-decoration: none;
            border-bottom: 1px dotted #0085FF;
            margin: 0 .2em;
        }
        a.join, a.create-room
        {
            background: url(https://webrtc-experiment.appspot.com/images/accept.png) no-repeat left center;
        }
        a.logo
        {
            background: url(https://webrtc-experiment.appspot.com/images/right-arrow.png) no-repeat left center;
        }
        footer a
        {
            background: url(https://webrtc-experiment.appspot.com/images/link.png) no-repeat left 17px;
        }
        a.search-room
        {
            background: url(https://webrtc-experiment.appspot.com/images/search.png) no-repeat left center;
            padding-left: 2em;
        }
        a:hover
        {
            color:red;
        }

        small
        {
            font-size: .6em;
        }
        footer
        {
            text-align: center;
        }
        .roshan
        {
            color:red;
        }

        /* app specific styles! */
        label {
                display: inline-block;
                font-size: 20px;
                width: 150px;
        }
        input
        {
            font-size: 1.2em;
        }
        .create-room-panel h2, .create-room-panel div, .public-rooms blockquote
        {
            padding: .2em;
            border-bottom: 1px double #CACACA;
            margin-bottom: .5em;
        }

        .create-room
        {
            display: block;
        }
        .g-plusone { position: static;}
        .plusone-gplus
        {
            top: 2.8em;
            margin-left: -1.7em;
            position: absolute;
        }

        .loader
        {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.75) url(https://webrtc-experiment.appspot.com/images/spinner.gif) no-repeat center 5em;
            z-index: 10;
            display: none;
        }
	</style>

    <link rel="canonical" href="https://webrtc-experiment.appspot.com/javascript/" />
</head>
<body>
    <div pub-key="demo" sub-key="demo" ssl="on" origin="pubsub.pubnub.com" id="pubnub"></div>
    <script src="http://cdn.pubnub.com/pubnub-3.3.1.min.js"></script>
    <table>
        <tr>
            <td>
                <a class="logo" href="https://plus.google.com/100325991024054712503">
                    <img src="https://webrtc-experiment.appspot.com/images/Logo.jpg" width=100 height=100>
                </a>
            </td>

            <td>
                <h1>(Pubnub/JavaScript) WebRTC Experiment</h1>
                <blockquote class="slogan">
                    WebRTC Experiment that uses Pubnub for signaling to make a realtime handshake!
                </blockquote>
            </td>
        </tr>
    </table>

    <div class="loader"></div>

    <table class="center-table">
        <tr>
            <td>
                <h2>Public meeting rooms!</h2>

                <section id="public-rooms"></section>
            </td>

            <td class="create-room-panel">
                <h2>Create new Room</h2>

                <div>
                    <label for="full-name">Your name:</label>
                    <input type="text" id="full-name"><br />
                    <small>Enter your full name.</small>
                </div>

                <div>
                    <label for="room-name">Room name:</label>
                    <input type="text" id="room-name"><br />
                    <small>Enter human-readable room name.</small>
                </div>

                <div id="partner-email" style="overflow:hidden;padding:0;margin:0;border:0;height:0;padding-left: 0!important;">
                    <label for="partner-email">Partner email:</label>
                    <input type="text" id="partner-email"><br />
                    <small>Enter your partner's email or unique token/word.</small>
                </div>

                <div style="float:right;">
                    <input type="checkbox" id="is-private" style="margin-left: 20px;" />
                    <label for="is-private" style="width: auto;">Is Private Room?</label>
                </div>

                <a id="create-room" class="create-room" href="#create-room">Create Room</a>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <section class="create-room-panel">
                    <h2>Searching for a private room?</h2>
                    <div>
                        <label for="email">Your email:</label>
                        <input type="text" id="email" style="width: 8.9em;">

                        <a id="search-room" class="search-room" href="#search-room">Search</a>

                        <small style="display:block;">Enter the email or token that your room partner given you.</small>
                    </div>
                </section>
            </td>
        </tr>
    </table>

    <video id="client-video" muted style="position: absolute; top: 0; z-index: -1;"></video>
    <video id="remote-video" style="display: none; position: absolute; top: 0;"></video>

    <section class="plusone-gplus">
        <div class="g-plusone" data-href="https://webrtc-experiment.appspot.com/"></div>
    </section>

    <footer>
      <a href="https://webrtc-experiment.appspot.com/">Home</a>
    © <a href="https://plus.google.com/100325991024054712503" rel="author">Muaz Khan</a>, {year}
      » <a href="mailto:muazkh@gmail.com">Email</a>
      » <a href="http://twitter.com/muazkh">@muazkh</a>
      » <a href="https://github.com/muaz-khan">Github</a>
    </footer>

    <script>
        function $(n, t, i) { try { return i ? n && !t ? i.querySelector(n) : i.querySelectorAll(n) : n && !t ? window.document.querySelector(n) : window.document.querySelectorAll(n) } catch (r) { return document.getElementById(n.replace("#", "")) } }Object.prototype.each = function (n) { for (var i = this.length, t = 0; t < i; t++) n(this[t]); return this }, Object.prototype.hide = function () { return this.length != undefined ? this.each(function (n) { n.style.display = "none" }) : typeof this == "object" && (this.style.display = "none"), this }, Object.prototype.show = function (n) { return this.length != undefined ? this.each(function (t) { t.style.display = n ? n : "block" }) : typeof this == "object" && (this.style.display = n ? n : "block"), this }, Object.prototype.css = function (n, t) { return this.style[n] = t, this }, Object.prototype.slideDown = function (n) { return this.css("max-height", (n || 1e6) + "px") }, Object.prototype.slideUp = function () { return this.css("max-height", "0") };

        function log(message) {
            document.title = message == '<img src="/images/loader.gif">' ? 'Waiting...' : message;
            $('footer').innerHTML = message;
        }

        window.PeerConnection = window.webkitRTCPeerConnection || window.mozRTCPeerConnection || window.RTCPeerConnection;
        window.SessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.RTCSessionDescription;
        window.IceCandidate = window.RTCIceCandidate || window.mozRTCIceCandidate || window.RTCIceCandidate;

        window.URL = window.webkitURL || window.URL;
        navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.getUserMedia;

        var global = {}, RTC = { active: false }, peerConnection;

        RTC.init = function (response) {
            if (!peerConnection) {
                try {
                    //TURN Server:     { "iceServers": [{ "url": "turn:webrtc%40live.com@numb.viagenie.ca", "credential": "muazkh" }] }
                        peerConnection = new PeerConnection({ "iceServers": [{ "url": "stun:stun.l.google.com:19302" }] });
                } catch (e) {
                    $('body').innerHTML = '<h1>WebRTC is not supported in this web browser!</h1>';
                }
                peerConnection.onicecandidate = RTC.onicecandidate;
                peerConnection.onaddstream = RTC.onaddstream;
                peerConnection.addStream(global.clientStream);

                RTC.active = true;
            }

            if (global.offerer && response) {
                peerConnection.setRemoteDescription(new SessionDescription(JSON.parse(response)));
            } else if (response) {
                peerConnection.setRemoteDescription(new SessionDescription(JSON.parse(response)));

                peerConnection.createAnswer(function (sessionDescription) {
                    peerConnection.setLocalDescription(sessionDescription);

                    var sdp = JSON.stringify(sessionDescription);
                    var firstPart = sdp.substr(0, 700),
                            secondPart = sdp.substr(701, sdp.length - 1);

                    pubnub.send({
                        userToken: global.userToken,
                        firstPart: firstPart
                    });

                    pubnub.send({
                        userToken: global.userToken,
                        secondPart: secondPart
                    });
                }, null, { audio: true, video: true });

            }

            if (!response && global.offerer && global.participant) {
                peerConnection.createOffer(function (sessionDescription) {
                    peerConnection.setLocalDescription(sessionDescription);

                    var sdp = JSON.stringify(sessionDescription);
                    var firstPart = sdp.substr(0, 700),
                            secondPart = sdp.substr(701, sdp.length - 1);

                    pubnub.send({
                        userToken: global.userToken,
                        firstPart: firstPart
                    });

                    pubnub.send({
                        userToken: global.userToken,
                        secondPart: secondPart
                    });
                }, null, { audio: true, video: true });
            }
        };

        RTC.onicecandidate = function (event) {
            if (global.stopSendingICE || !event.candidate || !peerConnection) return;

            pubnub.send({
                userToken: global.userToken,
                candidate: {
                    sdpMLineIndex: event.candidate.sdpMLineIndex,
                    candidate: JSON.stringify(event.candidate.candidate)
                }
            });

            log('Posted ICE: ' + event.candidate.candidate);
        };

        var remoteVideo = $('#remote-video');
        RTC.onaddstream = function (remoteEvent) {
            if (remoteEvent) {
                remoteVideo.css('top', '-100%').show().play();

                if (!navigator.mozGetUserMedia) remoteVideo.src = window.URL.createObjectURL(remoteEvent.stream);
                else remoteVideo.mozSrcObject = remoteEvent.stream;

                RTC.waitUntilRemoteStreamStartFlowing();
            }
        };

        RTC.waitUntilRemoteStreamStartFlowing = function () {
            log('Waiting for remote stream flow!');
            if (!(remoteVideo.readyState <= HTMLMediaElement.HAVE_CURRENT_DATA || remoteVideo.paused || remoteVideo.currentTime <= 0)) {
                global.isGotRemoteStream = true;

                remoteVideo.css('top', 0);
                clientVideo.css('width', (innerWidth / 4) + 'px').css('height', '').css('z-index', 2000000);

                $('.loader, table', true).hide();

                pubnub.send({
                    userToken: global.userToken,
                    gotStream: true
                });

                log('Finally got the remote stream!');
            } else setTimeout(RTC.waitUntilRemoteStreamStartFlowing, 200);
        };


        function uniqueToken() {
            var S4 = function () {
                return Math.floor(Math.random() * 0x10000).toString(16);
            };

            return S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4();
        }

        $('.loader').css('width', innerWidth + 'px').css('height', (innerHeight + document.body.clientHeight) + 'px');
        function hideListsAndBoxes() {
            $('.loader').show();

            global.isGetAvailableRoom = false;
        }

        hideListsAndBoxes();

        function showListsAndBoxes() {
            $('.loader').hide();
            $('table', true).show();

            global.isGetAvailableRoom = true;
        }

        global.mediaAccessAlertMessage = 'This app wants to use your camera and microphone.\n\nGrant it the access!';

        global.userToken = uniqueToken();
        $('#remote-video').css('width', innerWidth + 'px').css('height', innerHeight + 'px');
        $('#client-video').css('width', innerWidth + 'px').css('height', innerHeight + 'px');

        $('#is-private').onchange = function()
        {
            if (this.checked) $('#partner-email').css('padding', '10px 20px').css('height', 'auto').css('border-bottom', '1px double #CACACA').slideDown().querySelector('#partner-email').focus();
            else $('#partner-email').css('padding', 0).css('border-bottom', 0).slideUp();
        };

        $('#create-room').onclick = function()
        {
            var fullName = $('#full-name'),
                    roomName = $('#room-name'),
                    partnerEmail = $('input#partner-email');

            if (fullName.value.length <= 0) {
                alert('Please enter your full name.');
                fullName.focus();
                return;
            }

            if (roomName.value.length <= 0) {
                alert('Please enter room name.');
                roomName.focus();
                return;
            }

            var isChecked = $('#is-private').checked;

            if (isChecked && partnerEmail.value.length <= 0) {
                alert('Please enter your partner\'s email or token.');
                partnerEmail.focus();
                return;
            }

            if (!global.clientStream) {
                alert(global.mediaAccessAlertMessage);
                return;
            }

            global.userName = fullName.value;
            global.roomName = roomName.value;
            global.isGetAvailableRoom = false;
            hideListsAndBoxes();
            global.roomToken = uniqueToken();

            if (isChecked && partnerEmail.value.length) {
                pubnub.unsubscribe();
                pubnub.channel = partnerEmail.value;
                global.isPrivateRoom = true;

                initPubNub();
            }

            global.offerer = true;

            spreadRoom();
            window.scrollTo(0, 0);
        };

        function spreadRoom() {
            var g = global;

            pubnub.send({
                roomToken: g.roomToken,
                ownerName: g.userName,
                ownerToken: g.userToken,
                roomName: g.roomName
            });

            !global.participant && setTimeout(spreadRoom, 500);
        }

        $('#search-room').onclick = function()
        {
            var email = $('input#email');
            if (!email.value.length) {
                alert('Please enter the email or unique token/word that your partner given you.');
                email.focus();
                return;
            }

            global.searchPrivateRoom = email.value;

            log('Creating channel: ' + email.value);

            pubnub.unsubscribe();
            pubnub.channel = email.value;
            initPubNub(function () {
                log('Searching a private room for: ' + global.searchPrivateRoom);
                email.value = '';
            });
            window.scrollTo(0, 0);
        };


        var clientVideo = $('#client-video');

        function captureCamera() {
            navigator.getUserMedia({ audio: true, video: true },
                    function (stream) {

                        if (!navigator.mozGetUserMedia) clientVideo.src = window.URL.createObjectURL(stream);
                        else clientVideo.mozSrcObject = stream;

                        global.clientStream = stream;

                        clientVideo.play();
                    },
                    function () {
                        location.reload();
                    });
        }

        global.isGetAvailableRoom = true;
        global.defaultChannel = 'WebRTC Experiments Room';
        var pubnub = {
            channel: global.defaultChannel
        };

        var PUBNUB = window.PUBNUB || {};
        pubnub.init = function (pub) {
            PUBNUB.subscribe({
                channel: pubnub.channel,
                restore: false,
                callback: pub.callback,
                disconnect: pub.disconnect,
                connect: pub.connect
            });
        };

        pubnub.send = function (data) {
            PUBNUB.publish({
                channel: pubnub.channel,
                message: data
            });
        };

        pubnub.unsubscribe = function () {
            PUBNUB.unsubscribe({ channel: pubnub.channel });
        };

        var publicRooms = $('#public-rooms');

        function getAvailableRooms(response) {
            if (!global.isGetAvailableRoom || !response.ownerToken) return;

            var alreadyExist = $('#' + response.ownerToken);
            if (alreadyExist) return;

            var blockquote = document.createElement('blockquote');
            blockquote.setAttribute('id', response.ownerToken);

            blockquote.innerHTML = response.roomName
                        + '<a href="#" class="join" id="' + response.roomToken + '">Join Room</a><br/>'
                        + '<br /><small>Created by <span class="roshan">' + response.ownerName + '</span></small>';

            publicRooms.insertBefore(blockquote, publicRooms.childNodes[0]);

            $('.join', true).each(function (span) {
                span.onclick = function()
                {
                    if (!global.clientStream) {
                        alert(global.mediaAccessAlertMessage);
                        return;
                    }

                    global.userName = prompt('Enter your name');

                    if (!global.userName.length) {
                        alert('You\'ve not entered your name. Too bad!');
                        return;
                    }

                    global.isGetAvailableRoom = false;
                    hideListsAndBoxes();

                    global.roomToken = this.id;

                    var forUser = this.parentNode.id;

                    pubnub.send({
                        participant: global.userName,
                        userToken: global.userToken,
                        forUser: forUser
                    });


                    if (!global.searchPrivateRoom) {
                        pubnub.send({
                            userToken: global.userToken,
                            isBusyRoom: true,
                            ownerToken: forUser
                        });

                        pubnub.unsubscribe();

                        pubnub.channel = global.roomToken;
                        initPubNub();
                    }


                    window.scrollTo(0, 0);
                    this.parentNode.parentNode.removeChild(this.parentNode);
                };
            });
        }

        function refreshUI() {
            log('RTC room is closed by other user.');
            remoteVideo.css('top', '-100%').pause();
            remoteVideo.setAttribute('src', '');
            clientVideo.css('width', innerWidth + 'px').css('height', innerHeight + 'px').css('z-index', -1);

            $('table', true).show();
            $('.loader').hide();

            RTC.active = false;
            peerConnection.close();
            peerConnection = null;

            global.isGetAvailableRoom = true;
            global.isGotRemoteStream = false;

            pubnub.unsubscribe();
            pubnub.channel = global.defaultChannel;
        }

        function initPubNub(callback) {
            pubnub.init({
                callback: function (response) {
                    if (response.userToken === global.userToken) return;

                    if (response.isBusyRoom && response.ownerToken !== global.userToken) {
                        var owner = $('#' + response.ownerToken);
                        if (owner) {
                            owner = owner.parentNode;
                            owner.parentNode.removeChild(owner);
                        }
                    }
                    else if (global.isGetAvailableRoom && response.roomToken) getAvailableRooms(response);
                    else if (response.firstPart || response.secondPart) {
                        if (response.firstPart) {
                            global.firstPart = response.firstPart;
                            if (global.secondPart) {
                                RTC.init(global.firstPart + global.secondPart);
                            }
                        }
                        if (response.secondPart) {
                            global.secondPart = response.secondPart;
                            if (global.firstPart) {
                                RTC.init(global.firstPart + global.secondPart);
                            }
                        }
                    } else if (response.participant && response.forUser == global.userToken) {
                        setTimeout(function () {
                            global.participant = response.participant;
                            if (!global.isPrivateRoom) {
                                pubnub.unsubscribe();
                                pubnub.channel = global.roomToken;
                                initPubNub(RTC.init);
                            }
                            else RTC.init();
                        }, 100);
                    }
                    else if (response.sdp) {
                        RTC.init(response);
                    }
                    else if (RTC.active && response.candidate && !global.isGotRemoteStream) {
                        peerConnection.addIceCandidate(new IceCandidate({
                            sdpMLineIndex: response.candidate.sdpMLineIndex,
                            candidate: JSON.parse(response.candidate.candidate)
                        }));
                    }
                    else if (response.gotStream) global.stopSendingICE = true;
                    else if (response.end) refreshUI();
                },
                connect: function () {
                    callback && callback();
                }
            });
        }

        initPubNub(function () {
            showListsAndBoxes();
            captureCamera();
        });

        window.onunload = window.onbeforeunload = function () {
            alert('You\'re trying to close the room.');
            pubnub.send({
                end: true,
                userName: global.userName,
                userToken: global.userToken
            });
        };

        (function () {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();

    </script>
</body>
</html>