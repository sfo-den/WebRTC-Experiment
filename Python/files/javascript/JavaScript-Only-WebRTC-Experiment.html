<!--
    /*=============================================== Good Luck! ====================================================
    *  Muaz Khan
    *  @muazkh:  http://twitter.com/muazkh
    *  Github:   github.com/muaz-khan
    *****************************************************************************************************************/
    -->
<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta itemprop="image" content="https://muazkh.appspot.com/images/WebRTC.png">

        <title>WebRTC Experiment (JavaScript Only) ® Muaz Khan</title>
        <meta name="description" content="WebRTC Experiment — A Realtime JavaScript Only WebRTC Experiment that uses PUBNUB to allow sharing of WebRTC audio/video streams smoothly and directly! It is WebRTC, a real WebRTC Experiment!">
    
        <link rel="author" type="text/html" href="https://plus.google.com/100325991024054712503">
        <meta name="author" content="Muaz Khan">
        <meta name="copyright" content="© Muaz Khan, {year}">
        <style>
            html, html * {
                -moz-transition: all .8s ease;
                -ms-transition: all .8s ease;
                -o-transition: all .8s ease;
                -webkit-transition: all .8s ease;
    
                -webkit-user-select: none;
                font-family: Georgia, Verdana, Arial, Sans-Serif;
                margin: 0;
                overflow: hidden;
                padding: 0;
    
                transition: all .8s ease;
            }

            html
            {
                color: #420808;
                background: hsl(48, 71%, 75%);
                background-image: url(/images/background-2.png);
            }

            header {
                background: hsla(53, 60%, 51%, 0.82);
                border-bottom: 5px solid rgba(32, 26, 26, 0.28);
                padding: 5px 15px;
            }

            .author { float: right; }

            h1, h2 {
                color: #420808;
                font-size: 3em;
                text-shadow: 0 0 5px #572E2E;
            }

            h2 { font-size: 2em; }

            .slogan { font-size: 20px; }

            a {
                color: white;
                text-decoration: none;
            }

            a:hover { color: #DBCBCB; }

            footer {
                background: hsla(53, 60%, 51%, 0.82);
                bottom: 0;
                font-size: 28px;
                position: absolute;
                text-align: center;
                width: 100%;
            }

            footer span {
                background: rgba(1, 11, 15, 0.23);
                padding: 0 .5em;
            }

            menu { float: right; }

            menu a, footer a {
                color: #420808;
                text-shadow: 0 0 5px #572E2E;
            }

            menu a:hover {
                color: black;
                text-shadow: 0 0 5px black;
            }

            aside {
                margin-left: 80%;
                max-height: 80.8%;
                overflow: auto;
                position: absolute;
                width: 20%;
            }

            aside h2 {
                font-size: 1.5em;
                font-weight: normal;
            }

            aside a { color: red!important; }

            aside div {
                background: rgba(238, 236, 227, 0.64);
                border: 1px solid rgba(32, 26, 26, 0.28);
                padding: 10px;
            }

            aside div:hover { background: rgba(238, 236, 227, 0.8); }

            aside span, #create-room, #search-room, #send-chat {
                background: rgba(82, 28, 28, 0.65);
                color: white;
                cursor: pointer;
                display: inline-block;
                margin: 5px;
                padding: 6px 17px;
            }

            aside span:hover, #create-room:hover, #search-room:hover, #send-chat:hover { background: rgba(82, 28, 28, 0.80); }

            aside span:active, #create-room:active, #search-room:active, #send-chat:active { background: rgba(82, 28, 28, 1); }

            .create-room-panel, .private-room, .chat-box {
                background: rgba(245, 241, 192, 0.94);
                border: 2px solid rgba(32, 26, 26, 0.28);
                box-shadow: 0 0 6px #DFDFDF;
                margin: 5%;
                position: absolute;
            }

            input {
                -webkit-user-select: initial;
                font-size: 25px;
                outline: none!important;
            }

            label {
                display: inline-block;
                font-size: 20px;
                width: 150px;
            }

            small {
                display: block;
                font-size: 11px;
            }

            .create-room-panel h2, .create-room-panel div, .private-room h2, .private-room div, .chat-box h2, .chat-box div {
                border-bottom: 2px solid rgba(32, 26, 26, 0.28);
                padding: 10px 20px;
            }

            .private-room {
                bottom: 4%;
                left: 34%;
                right: 16%;
            }

            .private-room h2 {
                font-size: 20px;
                font-weight: normal;
            }

            #search-room, #send-chat {
                float: right;
                margin-top: 1px;
            }

            #send-chat { margin: -33px 0; }

            .plusone-gplus {
                bottom: 5%;
                margin-left: 1em;
                position: absolute;
            }

            .chat-box {
                bottom: 0;
                display: none;
                margin: 0;
                right: 0;
                z-index: 10000;
            }

            .g-plusone { position: static;}
        </style>

        <link rel="canonical" href="https://webrtc-experiment.appspot.com/javascript/" />
        
    </head>
    <body>
        <div pub-key="demo" sub-key="demo" ssl="on" origin="pubsub.pubnub.com" id="pubnub"></div>
        <script>{pubnub-js}</script>

        <header>
            <menu>
                <a href="/">HOME</a> » <a href="/rules/">Rules / Privacy</a> » <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/JavaScript-Only" target="_blank">Source code on Github!</a> » <a href="mailto:muazkh@gmail.com" title="Send Email to Muaz Khan">Email</a>
            </menu>
            <div class="slogan">Share your feelings directly & privately with friends!</div>
            <h1 title="Realtime JavaScript Only WebRTC Experiment!">WebRTC Experiment <div class="author">by <a href="https://plus.google.com/100325991024054712503" rel="author">Muaz Khan</a>!</div></h1>
        </header>

        <aside></aside>

        <section class="create-room-panel">
            <h2>Create a room</h2>
            <div>
                <label for="full-name">Your name:</label>
                <input type="text" id="full-name">
                <small>Enter your full name.</small>
            </div>

            <div>
                <label for="room-name">Room name:</label>
                <input type="text" id="room-name">
                <small>Enter human-readable room name.</small>
            </div>

            <div id="partner-email" style="border-bottom: 0; max-height: 0; padding: 0;">
                <label for="partner-email">Partner email:</label>
                <input type="text" id="partner-email">
                <small>Enter your partner's email or unique token/word.</small>
            </div>

            <input type="checkbox" id="is-private" style="margin-left: 20px;" />
            <label for="is-private" style="width: auto;">Is Private Room?</label>

            <div id="create-room" style="font-size: 20px; margin-left: 3.7em;">Create Room</div>
        </section>

        <section class="private-room">
            <h2>Searching for a private room?</h2>
            <div style="border: 0">
                <label for="email">Your email:</label>
                <input type="text" id="email">

                <div id="search-room">Search</div>

                <small>Enter the email or token that your room partner given you.</small>
            </div>
        </section>
    
        <section class="chat-box">
            <div style="border: 0">
                <label for="chat-message">Chat message:</label>
                <input type="text" id="chat-message">

                <div id="send-chat">Send</div>
            </div>
        </section>
    
	
        <section class="plusone-gplus"><div class="g-plusone" data-href="https://webrtc-experiment.appspot.com/"></div></section>
    
	
        <video id="client-video" muted style="position: absolute; top: 0; z-index: -1;"></video>
        <video id="remote-video" style="display: none; position: absolute; top: 0;"></video>

        <footer>
            © <a href="https://plus.google.com/100325991024054712503" rel="author">Muaz Khan</a>, {year}  » <a href="mailto:muazkh@gmail.com" title="Send Email to Muaz Khan">Email</a> » <a href="http://twitter.com/muazkh" title="Follow me on Twitter!">@muazkh</a>
        </footer>
        
        <script>
            var $ = function(term, selectAll, elem) {
                try {
                    if (!elem) {
                        if (term && !selectAll) return window.document.querySelector(term);
                        return window.document.querySelectorAll(term);
                    } else {
                        if (term && !selectAll) return elem.querySelector(term);
                        return elem.querySelectorAll(term);
                    }
                } catch(error) {
                    return document.getElementById(term.replace('#', ''));
                }
            };

            Object.prototype.bind = function(eventName, callback) {
                if (this.length != undefined) {
                    var length = this.length;
                    for (var i = 0; i < length; i++) {
                        this[i].addEventListener(eventName, callback, false);
                    }
                } else if (typeof this == 'object') this.addEventListener(eventName, callback, false);
                return this;
            };

            Object.prototype.each = function(callback) {
                var length = this.length;
                for (var i = 0; i < length; i++) {
                    callback(this[i]);
                }
                return this;
            };

            Object.prototype.find = function(element) {
                return this.querySelector(element);
            };

            FormData.prototype.appendData = function(name, value) {
                if (value || value == 0) this.append(name, value);
            };

            $.ajax = function(url, options) {

                var _url = options ? url : url.url;
                options = options || url;

                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200)
                        options.success(JSON.parse(xhr.responseText));
                };

                _url = 'http://webrtc.somee.com' + _url;
                xhr.open(options.type ? options.type : 'POST', _url);

                var formData = new window.FormData(),
                    data = options.data;

                if (data) {
                    formData.appendData('ownerName', data.ownerName);
                    formData.appendData('ownerToken', data.ownerToken);

                    formData.appendData('roomName', data.roomName);
                    formData.appendData('roomToken', data.roomToken);

                    formData.appendData('partnerEmail', data.partnerEmail);
                    formData.appendData('userToken', data.userToken);
                    formData.appendData('participant', data.participant);

                    formData.appendData('sdp', data.sdp);
                    formData.appendData('candidate', data.candidate);
                    formData.appendData('label', data.label);

                    formData.appendData('message', data.message);
                }

                xhr.send(formData);
            };

            Object.prototype.prepend = function(prependMe) {
                return this.insertBefore(prependMe, this.firstChild);
            };

            Object.prototype.hide = function() /* set display:none; to one or more elements */
            {
                if (this.length != undefined) /* if more than one elements */ {
                    this.each(function(elem) {
                        elem.style.display = 'none';
                    });
                } else if (typeof this == 'object') /* if only one element */ {
                    this.style.display = 'none';
                }
                return this;
            };
            Object.prototype.show = function(value) /* set display:block; to one or more elements */
            {
                if (this.length != undefined) /* if more than one elemens */ {
                    this.each(function(elem) {
                        if (value) elem.style.display = value;
                        else elem.style.display = 'block';
                    });
                } else if (typeof this == 'object') /* if only one element */ {
                    if (value) this.style.display = value;
                    else this.style.display = 'block';
                }
                return this;
            };

            Object.prototype.css = function(prop, value) {
                this.style[prop] = value;
                return this;
            };
            Object.prototype.html = function(value) {
                if (value || value == '') {
                    this.innerHTML = value;
                    return this;
                }
                return this.innerHTML;
            };
            $.once = function(seconds, callback) {
                var counter = 0;
                var time = window.setInterval(function() {
                    counter++;
                    if (counter >= seconds) {
                        callback();
                        window.clearInterval(time);
                    }
                }, 1000);
            };

            Object.prototype.slideDown = function(maxHeight) {
                return this.css('max-height', (maxHeight || 1000000) + 'px');
            };

            Object.prototype.slideUp = function() {
                return this.css('max-height', '0');
            };

            String.prototype.validate = function() {
                return this.replace(/-/g, '__').replace(/\?/g, '-qmark').replace(/ /g, '--').replace(/\n/g, '-n').replace(/</g, '-lt').replace(/>/g, '-gt').replace(/&/g, '-amp').replace(/#/g, '-nsign').replace(/__t-n/g, '__t').replace(/\+/g, '_plus_').replace(/=/g, '-equal');
            };

            function log(message) {
                document.title = message == '<img src="/images/loader.gif">' ? 'Waiting...' : message;
                $('footer').html(message);
            }


            window.PeerConnection = window.webkitRTCPeerConnection || window.mozRTCPeerConnection || window.RTCPeerConnection;
            window.SessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.RTCSessionDescription;
            window.IceCandidate = window.RTCIceCandidate || window.mozRTCIceCandidate || window.RTCIceCandidate;

            window.URL = window.webkitURL || window.URL;
            navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.getUserMedia;

            var global = {}, RTC = { active: false }, peerConnection;

            RTC.init = function(response) {
                if (!peerConnection) {
                    try {
                        peerConnection = new PeerConnection("{stun-turn}");
                    } catch(e) {
                        log('WebRTC is not supported in this web browser!');
                        alert('WebRTC is not supported in this web browser!');
                    }
                    peerConnection.onicecandidate = RTC.onicecandidate;
                    peerConnection.onaddstream = RTC.onaddstream;
                    peerConnection.addStream(global.clientStream);

                    RTC.active = true;
                }

                if (global.offerer && response) {
                    peerConnection.setRemoteDescription(new SessionDescription(JSON.parse(response)));
                } else if (response) {
                    peerConnection.setRemoteDescription(new SessionDescription(JSON.parse(response)));

                    peerConnection.createAnswer(function(sessionDescription) {
                        peerConnection.setLocalDescription(sessionDescription);

                        var sdp = JSON.stringify(sessionDescription);
                        var firstPart = sdp.substr(0, 700),
                            secondPart = sdp.substr(701, sdp.length - 1);

                        pubnub.send({
                            userToken: global.userToken,
                            firstPart: firstPart
                        });

                        pubnub.send({
                            userToken: global.userToken,
                            secondPart: secondPart
                        });
                    }, null, { audio: true, video: true });

                }

                if (!response && global.offerer && global.participant) {
                    peerConnection.createOffer(function(sessionDescription) {
                        peerConnection.setLocalDescription(sessionDescription);

                        var sdp = JSON.stringify(sessionDescription);
                        var firstPart = sdp.substr(0, 700),
                            secondPart = sdp.substr(701, sdp.length - 1);

                        pubnub.send({
                            userToken: global.userToken,
                            firstPart: firstPart
                        });

                        pubnub.send({
                            userToken: global.userToken,
                            secondPart: secondPart
                        });
                    }, null, { audio: true, video: true });
                }
            };

            RTC.onicecandidate = function (event) {
                if (global.stopSendingICE || !event.candidate || !peerConnection) return;
                
                pubnub.send({
                    userToken: global.userToken,
                    candidate: {
                        sdpMLineIndex: event.candidate.sdpMLineIndex,
                        candidate: JSON.stringify(event.candidate.candidate)
                    }
                });

                log('Posted ICE: ' + event.candidate.candidate);
            };

            var remoteVideo = $('#remote-video');
            RTC.onaddstream = function(remoteEvent) {
                if (remoteEvent) {
                    remoteVideo.css('top', '-100%').show().play();

                    if (!navigator.mozGetUserMedia) remoteVideo.src = window.URL.createObjectURL(remoteEvent.stream);
                    else remoteVideo.mozSrcObject = remoteEvent.stream;

                    RTC.waitUntilRemoteStreamStartFlowing();
                }
            };

            RTC.waitUntilRemoteStreamStartFlowing = function() {
                log('Waiting for remote stream flow!');
                if (!(remoteVideo.readyState <= HTMLMediaElement.HAVE_CURRENT_DATA || remoteVideo.paused || remoteVideo.currentTime <= 0)) {
                    global.isGotRemoteStream = true;

                    remoteVideo.css('top', 0);
                    clientVideo.css('width', (innerWidth / 4) + 'px').css('height', '').css('z-index', 2000000);

                    pubnub.send({
                        userToken: global.userToken,
                        gotStream: true
                    });

                    log('Finally got the remote stream!');
                    startChatting();
                } else setTimeout(RTC.waitUntilRemoteStreamStartFlowing, 200);
            };


            function uniqueToken() {
                var S4 = function() {
                    return Math.floor(Math.random() * 0x10000).toString(16);
                };

                return S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4();
            }

            function hideListsAndBoxes() {
                $('.create-room-panel').css('left', '-100%');
                $('aside').css('right', '-100%');
                $('.private-room').css('bottom', '-100%');

                global.isGetAvailableRoom = false;
            }

            hideListsAndBoxes();

            function showListsAndBoxes() {
                $('.create-room-panel').css('left', 'auto');
                $('aside').css('right', 'auto');
                $('.private-room').css('bottom', '4%');

                global.isGetAvailableRoom = true;
            }

            global.mediaAccessAlertMessage = 'This app wants to use your camera and microphone.\n\nGrant it the access!';

            global.userToken = uniqueToken();
            $('#remote-video').css('width', innerWidth + 'px').css('height', innerHeight + 'px');
            $('#client-video').css('width', innerWidth + 'px').css('height', innerHeight + 'px');

            $('#is-private').bind('change', function() {
                if (this.checked) $('#partner-email').css('padding', '10px 20px').css('border-bottom', '2px solid rgba(32, 26, 26, 0.28)').slideDown().find('#partner-email').focus();
                else $('#partner-email').css('padding', 0).css('border-bottom', 0).slideUp();
            });

            $('#create-room').bind('click', function () {
                var fullName = $('#full-name'),
                    roomName = $('#room-name'),
                    partnerEmail = $('input#partner-email');

                if (fullName.value.length <= 0) {
                    alert('Please enter your full name.');
                    fullName.focus();
                    return;
                }

                if (roomName.value.length <= 0) {
                    alert('Please enter room name.');
                    roomName.focus();
                    return;
                }

                var isChecked = $('#is-private').checked;

                if (isChecked && partnerEmail.value.length <= 0) {
                    alert('Please enter your partner\'s email or token.');
                    partnerEmail.focus();
                    return;
                }

                if (!global.clientStream) {
                    alert(global.mediaAccessAlertMessage);
                    return;
                }

                global.userName = fullName.value;
                global.roomName = roomName.value;
                global.isGetAvailableRoom = false;
                hideListsAndBoxes();
                global.roomToken = uniqueToken();

                if (isChecked && partnerEmail.value.length) global.roomToken = partnerEmail.value + global.roomToken;
                global.offerer = true;
                global.isPrivate = isChecked && partnerEmail.value.length;

                spreadRoom();
            });

            function spreadRoom() {
                var g = global;
                
                pubnub.send({
                    roomToken: g.roomToken,
                    ownerName: g.userName,
                    ownerToken: g.userToken,
                    roomName: g.roomName,
                    isPrivate: g.isPrivate
                });

                !global.participant && setTimeout(spreadRoom, 500);
            }

            $('#search-room').bind('click', function() {
                var email = $('input#email');
                if (!email.value.length) {
                    alert('Please enter the email or unique token/word that your partner given you.');
                    email.focus();
                    return;
                }

                global.searchPrivateRoom = email.value;

                $('.private-room').css('bottom', '-100%');
                log('Searching a private room for: ' + global.searchPrivateRoom);
            });


            var clientVideo = $('#client-video');

            function captureCamera() {
                navigator.getUserMedia({ audio: true, video: true },
                    function(stream) {

                        if (!navigator.mozGetUserMedia) clientVideo.src = window.URL.createObjectURL(stream);
                        else clientVideo.mozSrcObject = stream;

                        global.clientStream = stream;

                        clientVideo.play();
                    },
                    function() {
                        location.reload();
                    });
            }

            global.isGetAvailableRoom = true;
            global.defaultChannel = 'WebRTC Experiments Room';
            var pubnub = {
                channel: global.defaultChannel
            };

            var PUBNUB = window.PUBNUB || {};
            pubnub.init = function(pub) {
                PUBNUB.subscribe({
                    channel: pubnub.channel,
                    restore: false,
                    callback: pub.callback,
                    disconnect: pub.disconnect,
                    connect: pub.connect
                });
            };

            pubnub.send = function(data) {
                PUBNUB.publish({
                    channel: pubnub.channel,
                    message: data
                });
            };

            var aside = $('aside');

            function getAvailableRooms(response) {
                if (!global.isGetAvailableRoom || !response.ownerToken) return;

                if (response.isPrivate === true) {
                    document.title = 'private';
                    if (!global.searchPrivateRoom) return;
                    if (response.roomToken.indexOf(global.searchPrivateRoom) !== 0) return;
                }

                var alreadyExist = $('#' + response.ownerToken);
                if (alreadyExist) return;

                aside.innerHTML = '<div id="' + response.ownerToken + '"><h2>' + response.roomName + '</h2><small>Created by ' + response.ownerName + '</small><span id="' + response.roomToken + '">Join</span></div>' + aside.innerHTML;

                $('aside span', true).each(function (span) {
                    span.bind('click', function () {
                        if (!global.clientStream) {
                            alert(global.mediaAccessAlertMessage);
                            return;
                        }

                        global.userName = prompt('Enter your name');

                        if (!global.userName.length) {
                            alert('You\'ve not entered your name. Too bad!');
                            return;
                        }

                        global.isGetAvailableRoom = false;
                        hideListsAndBoxes();

                        global.roomToken = this.id;

                        var forUser = this.parentNode.id;

                        pubnub.send({
                            participant: global.userName,
                            userToken: global.userToken,
                            forUser: forUser
                        });

                        pubnub.send({
                            userToken: global.userToken,
                            isBusyRoom: true,
                            ownerToken: forUser
                        });

                        pubnub.channel = global.roomToken;
                        initPubNub();
                    });
                });
            }


            function startChatting() {
                $('footer').css('bottom', '-100%');
                
                $('aside').innerHTML = '';
                $('aside').css('z-index', 100).css('top', 0).css('right', 0).show();

                $('.chat-box').show().find('#chat-message').bind('keyup', function(e) {
                    if (e.keyCode == 13) postChatMessage();
                });

                $('#send-chat').bind('click', function() {
                    postChatMessage();
                });
            }

            function postChatMessage() {
                var chatBox = $('#chat-message'),
                    message = chatBox.value;

                pubnub.send({
                    userName: global.userName,
                    userToken: global.userToken,
                    isChat: true,
                    message: message
                });

                chatBox.value = '';
                chatBox.focus();
            }

            function getChatMessage(response) {
                if(!response.message.length) return;
                aside.innerHTML = '<div><h2>' + response.userName + '</h2>' + response.message + '</div>' + aside.innerHTML;
                document.title = response.userName + ': ' + response.message;
            }

            function refreshUI() {
                $('footer').css('bottom', '0');
                $('aside').innerHTML = '';
                $('aside').css('z-index', 100).css('top', 'auto').css('right', '0').show();
                $('.chat-box').hide();
                $('.private-room').css('bottom', '4%');
                $('.create-room-panel').css('left', 'auto');

                log('RTC room is closed by other user.');
                remoteVideo.css('top', '-100%').pause();
                remoteVideo.setAttribute('src', '');
                clientVideo.css('width', innerWidth + 'px').css('height', innerHeight + 'px').css('z-index', -1);

                RTC.active = false;
                peerConnection.close();
                peerConnection = null;

                global.isGetAvailableRoom = true;
                global.isGotRemoteStream = false;

                pubnub.channel = global.defaultChannel;
                //initPubNub();
            }

            function initPubNub(callback) {
                pubnub.init({
                    callback: function (response) {
                        if (response.userToken === global.userToken) return;

                        if (response.isBusyRoom && response.ownerToken !== global.userToken) {
                            var owner = $('#' + response.ownerToken);
                            if (owner) {
                                owner = owner.parentNode;
                                owner.parentNode.removeChild(owner);
                            }
                        }
                        else if (global.isGetAvailableRoom && response.roomToken) getAvailableRooms(response);
                        else if (response.firstPart || response.secondPart) {
                            if (response.firstPart) {
                                global.firstPart = response.firstPart;
                                if (global.secondPart) {
                                    RTC.init(global.firstPart + global.secondPart);
                                }
                            }
                            if (response.secondPart) {
                                global.secondPart = response.secondPart;
                                if (global.firstPart) {
                                    RTC.init(global.firstPart + global.secondPart);
                                }
                            }
                        } else if (response.participant && response.forUser == global.userToken) {
                            setTimeout(function () {
                                global.participant = response.participant;
                                pubnub.channel = global.roomToken;
                                initPubNub(RTC.init);
                            }, 100);
                        }
                        else if (response.sdp) {
                            RTC.init(response);
                        }
                        else if (RTC.active && response.candidate && !global.isGotRemoteStream) {
                            peerConnection.addIceCandidate(new IceCandidate({
                                sdpMLineIndex: response.candidate.sdpMLineIndex,
                                candidate: JSON.parse(response.candidate.candidate)
                            }));
                        }
                        else if (response.isChat) getChatMessage(response);
                        else if (response.gotStream) global.stopSendingICE = true;
                        else if (response.end) refreshUI();
                    },
                    connect: function () {
                        callback && callback();
                    }
                });
            }

            initPubNub(function () {
                showListsAndBoxes();
                captureCamera();
            });

            window.onunload = window.onbeforeunload = function () {
                alert('You\'re try to close the room.');
                pubnub.send({
                    end: true,
                    userName: global.userName,
                    userToken: global.userToken
                });
            };
            
            (function () {
                var po = document.createElement('script');
                po.type = 'text/javascript';
                po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(po, s);
            })();

        </script>
    </body>
</html>