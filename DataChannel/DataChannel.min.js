"use strict";!function(){function e(e,n){function t(t){function i(n){"one-to-one"===e.direction&&window.isFirstConnectionOpened||(n?(b.offerSDP=n,b.onAnswerSDP=d):b.onOfferSDP=d,k=new r(b))}function s(o){o.peer=k.peer,h.push(o),n.onopen(t.userid,o),"many-to-many"===e.direction&&l&&u.split("--").length>3&&m&&m.send({newParticipant:w.channel,userToken:c.userToken,roomToken:e.roomid}),window.isFirstConnectionOpened=v=!0}function d(e){e=JSON.stringify(e);var n=parseInt(e.length/3),o=e.slice(0,n),t=e.slice(n,e.length-1),i="";e.length>n+n&&(t=e.slice(n,n+n),i=e.slice(n+n,e.length)),w.send({userToken:c.userToken,firstPart:o}),w.send({userToken:c.userToken,secondPart:t}),w.send({userToken:c.userToken,thirdPart:i})}function f(n){n.userToken!==c.userToken&&((n.firstPart||n.secondPart||n.thirdPart)&&(n.firstPart&&(t.userid=n.userToken,S.firstPart=n.firstPart,S.secondPart&&S.thirdPart&&p()),n.secondPart&&(S.secondPart=n.secondPart,S.firstPart&&S.thirdPart&&p()),n.thirdPart&&(S.thirdPart=n.thirdPart,S.firstPart&&S.secondPart&&p())),n.candidate&&!v&&k&&(k.addICE({sdpMLineIndex:n.candidate.sdpMLineIndex,candidate:JSON.parse(n.candidate.candidate)}),console.debug("ice candidate",n.candidate.candidate)),n.left&&(k&&k.peer&&(k.peer.close(),k.peer=null),n.closeEntireSession?a():w&&(w.send({left:!0,userToken:c.userToken}),w=null),e.onleave(n.userToken)),n.playRoleOfBroadcaster&&setTimeout(function(){c.roomToken=n.roomToken,e.open(c.roomToken),c.sockets=o(c.sockets)},600))}function p(){P||(P=!0,S.sdp=JSON.parse(S.firstPart+S.secondPart+S.thirdPart),T?k.addAnswerSDP(S.sdp):i(S.sdp),console.debug("sdp",S.sdp.sdp))}var g={channel:t.channel,onmessage:f,onopen:function(){T&&!k&&i(),t.socketIndex=w.index=c.sockets.length,c.socketObjects[g.channel]=w,c.sockets[t.socketIndex]=w}};g.callback=function(e){w=e,g.onopen()};var v,k,w=e.openSignalingChannel(g),T=t.isofferer,S={},b={onICE:function(e){return w?void w.send({userToken:c.userToken,candidate:{sdpMLineIndex:e.sdpMLineIndex,candidate:JSON.stringify(e.candidate)}}):setTimeout(function(){b.onICE(e)},2e3)},onopen:s,onmessage:function(e){n.onmessage(e.data,t.userid)},onclose:n.onclose,onerror:e.onerror,preferSCTP:e.preferSCTP},P=!1}function i(e){if(e&&-1===u.indexOf(e)&&e!==c.userToken){u+=e+"--";var n=s();t({channel:n,closeSocket:!0}),m&&m.send({participant:!0,userToken:c.userToken,joinUser:e,channel:n})}}function s(){return(Math.round(60535*Math.random())+5e6).toString()}function a(n){var t,i={left:!0,userToken:c.userToken};if(l&&(e.autoCloseEntireSession?i.closeEntireSession=!0:c.sockets[0].send({playRoleOfBroadcaster:!0,userToken:c.userToken,roomToken:c.roomToken})),!n){for(var r=c.sockets,s=r.length,a=0;s>a;a++)t=r[a],t&&(t.send(i),c.socketObjects[t.channel]&&delete c.socketObjects[t.channel],delete r[a]);d.left=!0}n&&(t=c.socketObjects[n],t&&(t.send(i),c.sockets[t.index]&&delete c.sockets[t.index],delete c.socketObjects[n])),c.sockets=o(c.sockets)}var c={},d=this;c.userToken=(e.userid=e.userid||s()).toString(),c.sockets=[],c.socketObjects={};var u="--",l=!1,f=!0,h=[];window.addEventListener("beforeunload",function(){a()},!1),window.addEventListener("keydown",function(e){116===e.keyCode&&a()},!1);var m=e.openSignalingChannel({onmessage:function(o){o.userToken!==c.userToken&&(f&&o.roomToken&&o.broadcaster&&n.ondatachannel(o),o.newParticipant&&o.roomToken===e.roomid&&i(o.newParticipant),o.userToken&&o.joinUser===c.userToken&&o.participant&&-1===u.indexOf(o.userToken)&&(u+=o.userToken+"--",console.debug("Data connection is being opened between you and",o.userToken||o.channel),t({isofferer:!0,channel:o.channel||o.userToken,closeSocket:!0})))},callback:function(e){m=e}});return{createRoom:function(n){c.roomToken=(n||s()).toString(),l=!0,f=!1,function o(){m&&m.send({roomToken:c.roomToken,broadcaster:c.userToken}),e.transmitRoomOnce||d.leaving||("one-to-one"===e.direction?window.isFirstConnectionOpened||setTimeout(o,3e3):setTimeout(o,3e3))}()},joinRoom:function(e){c.roomToken=e.roomToken,f=!1,t({channel:c.userToken}),m.send({participant:!0,userToken:c.userToken,joinUser:e.joinUser})},send:function(e,n){var o,t=h,i=t.length;if(i){if(o=JSON.stringify(e),n)return void("open"===n.readyState&&n.send(o));for(var r=0;i>r;r++)"open"===t[r].readyState&&t[r].send(o)}},leave:function(n,o){o&&(e.autoCloseEntireSession=!0),a(n),n||(c.joinedARoom=l=!1,f=!0)}}}function n(){return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"-")}function o(e){for(var n=[],o=e.length,t=0;o>t;t++)e[t]&&n.push(e[t]);return n}function t(e,n){window.removeEventListener(e,n),window.addEventListener(e,n,!1)}function i(e,n){if(!g){if(!n)return i(e,!0);g=!0;var o=document.createElement("iframe");o.onload=function(){function n(o){o.data&&o.data.iceServers&&(e(o.data.iceServers),window.removeEventListener("message",n))}o.isLoaded=!0,t("message",n),o.contentWindow.postMessage("get-ice-servers","*")},o.src="https://cdn.webrtc-experiment.com/getIceServers/",o.style.display="none",(document.body||document.documentElement).appendChild(o)}}function r(e){function n(n){n.candidate&&v&&e.onICE&&e.onICE(n.candidate)}function o(e){var n=JSON.stringify(e,null,"  ");-1!==n.indexOf("RTP/SAVPF Expects at least 4 fields")&&(n="It seems that you are trying to interop RTP-datachannels with SCTP. It is not supported!"),console.error("onSdpError:",n)}function t(){}function i(){e.onOfferSDP&&v.createOffer(function(n){v.setLocalDescription(n),e.onOfferSDP(n)},o,k)}function r(){e.onAnswerSDP&&(e.offerSDP=new h(e.offerSDP),v.setRemoteDescription(e.offerSDP,t,o),v.createAnswer(function(n){v.setLocalDescription(n),e.onAnswerSDP(n)},o,k))}function s(){(!d||e.onOfferSDP)&&(d||e.onOfferSDP)&&(a(),d&&i())}function a(){var e={};console.debug("dataChannelDict",e),w=v.createDataChannel("channel",e),c()}function c(){w.onmessage=e.onmessage,w.onopen=function(){e.onopen(w)},w.onclose=e.onclose,w.onerror=e.onerror}function u(){v.ondatachannel=function(e){w=e.channel,c()},d&&r()}var l=window,f=l.mozRTCPeerConnection||l.webkitRTCPeerConnection,h=l.mozRTCSessionDescription||l.RTCSessionDescription,m=l.mozRTCIceCandidate||l.RTCIceCandidate,p=window.iceServers||[];p.push({url:"stun:stun.l.google.com:19302"}),p.push({url:"stun:stun.anyfirewall.com:3478"}),p.push({url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"}),p.push({url:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"}),p={iceServers:p};var g={optional:[]};navigator.onLine||(p=null,console.warn("No internet connection detected. No STUN/TURN server is used to make sure local/host candidates are used for peers connection."));var v=new f(p,g);s(),v.onicecandidate=n;var k=e.constraints||{optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}};d||(i(),r());var w;return e.onAnswerSDP&&d&&e.onmessage&&u(),d||e.onOfferSDP||u(),{addAnswerSDP:function(e){e=new h(e),v.setRemoteDescription(e,t,o)},addICE:function(e){v.addIceCandidate(new m({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate}))},peer:v,channel:w,sendData:function(e){w&&w.send(e)}}}function s(e){function n(n){var r=n.uuid;if("undefined"!=typeof n.packets&&(i[r]=t[r]=parseInt(n.packets)),e.onFileProgress&&e.onFileProgress({remaining:t[r]--,length:i[r],received:i[r]-t[r],maxChunks:i[r],uuid:r,currentPosition:i[r]-t[r]},r),o[r]||(o[r]=[]),o[r].push(n.message),n.last){var s=o[r].join("");v.DataURLToBlob(s,n.fileType,function(t){t.uuid=r,t.name=n.name,t.extra=n.extra||{},t.url=(window.URL||window.webkitURL).createObjectURL(t),e.autoSaveToDisk&&k.SaveToDisk(t.url,n.name),e.onFileReceived&&e.onFileReceived(t),delete o[r]})}}var o={},t={},i={};return{receive:n}}function a(e,n){var o=n.openSignalingChannel({channel:e,onopen:n.onopen,onmessage:n.onmessage,callback:function(e){o=e}});return{send:function(e){o&&o.send({userid:l,message:e})}}}function c(){function e(e,o,t){var i=e.uuid;if(n[i]||(n[i]=[]),n[i].push(e.message),e.last){var r=n[i].join("");e.isobject&&(r=JSON.parse(r));var s=(new Date).getTime(),a=s-e.sendingTime;o(r,t,a),delete n[i]}}var n={};return{receive:e}}window.DataChannel=function(n,o){function t(e){for(var t in o)f[t]=o[t];if(f.direction=f.direction||"many-to-many",f.userid&&(window.userid=f.userid),f.openSignalingChannel)e();else if("undefined"==typeof f.transmitRoomOnce&&(f.transmitRoomOnce=!0),f.openSignalingChannel=function(e){e=e||{},n=e.channel||f.channel||"default-channel";var o=new window.Firebase("https://"+(f.firebase||"webrtc-experiment")+".firebaseIO.com/"+n);return o.channel=n,o.on("child_added",function(n){e.onmessage(n.val())}),o.send=function(e){this.push(e)},f.socket||(f.socket=o),(n!==f.channel||f.isInitiator&&n===f.channel)&&o.onDisconnect().remove(),e.onopen&&setTimeout(e.onopen,1),o},window.Firebase)e();else{var i=document.createElement("script");i.src="https://cdn.webrtc-experiment.com/firebase.js",i.onload=e,document.documentElement.appendChild(i)}}function i(){f.config||(f.config={ondatachannel:function(e){if(!r)return void(f.room=e);var n={id:e.roomToken,owner:e.broadcaster};return f.ondatachannel?f.ondatachannel(n):void(f.joinedARoom||(f.joinedARoom=!0,f.join(n)))},onopen:function(e,n){f.onopen(e,n),f.channels[e]={channel:n,send:function(e){f.send(e,this.channel)}}},onmessage:function(e,n){if(u&&!e.size&&(e=JSON.parse(e)),!u){if(e.userid===window.userid)return;e=e.message}"text"===e.type?l.receive(e,f.onmessage,n):"undefined"!=typeof e.maxChunks?d.receive(e,f):f.onmessage(e,n)},onclose:function(e){var n=f.channels,o=e.currentTarget;for(var t in n)o===n[t].channel&&delete n[t];f.onclose(e)},openSignalingChannel:f.openSignalingChannel},r=u?new e(f,f.config):new a(f.channel,f.config),d=new s(f),l=new c(f),f.room&&f.config.ondatachannel(f.room))}n&&(this.automatic=!0),this.roomid=this.channel=n||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),o=o||{};var r,d,l,f=this;this.onmessage=function(e,n){console.debug(n,"sent message:",e)},this.channels={},this.onopen=function(e){console.debug(e,"is connected with you.")},this.onclose=function(e){console.error("data channel closed:",e)},this.onerror=function(e){console.error("data channel error:",e)},this.autoSaveToDisk=!0,this.onFileReceived=function(e){console.debug("File <",e,"> received successfully.")},this.onFileSent=function(e){console.debug("File <",e.name,"> sent successfully.")},this.onFileProgress=function(e){console.debug("<",e.remaining,"> items remaining.")},this.open=function(e){this.roomid=e,f.joinedARoom=!0,f.socket?f.socket.onDisconnect().remove():f.isInitiator=!0,e&&(f.channel=e),t(function(){i(),u&&r.createRoom(e)})},this.connect=function(e){e&&(f.channel=e),this.roomid=e,t(i)},this.join=function(e){if(!e.id||!e.owner)throw"Invalid room info passed.";this.roomid=e.id,r||i(),r.joinRoom&&r.joinRoom({roomToken:e.id,joinUser:e.owner})},this.send=function(e,n){if(!e)throw"No file, data or text message to share.";return"undefined"!=typeof e.size&&"undefined"!=typeof e.type?void w.send({file:e,channel:r,onFileSent:function(e){f.onFileSent(e)},onFileProgress:function(e,n){f.onFileProgress(e,n)},_channel:n,root:f}):void T.send({text:e,channel:r,_channel:n,root:f})},this.onleave=function(e){console.debug(e,"left!")},this.leave=this.eject=function(e){r.leave(e,f.autoCloseEntireSession)},this.openNewSession=function(e,n){if(e){if(f.isNewSessionOpened)return;f.isNewSessionOpened=!0,f.joinedARoom||f.open()}(!e||n)&&f.connect(),n&&setTimeout(function(){f.openNewSession(!0)},5e3)},"undefined"==typeof this.preferSCTP&&(this.preferSCTP=m||p>=32?!0:!1),"undefined"==typeof this.chunkSize&&(this.chunkSize=m||p>=32?13e3:1e3),"undefined"==typeof this.chunkInterval&&(this.chunkInterval=m||p>=32?100:500),f.automatic&&(window.Firebase?(console.debug("checking presence of the room.."),new window.Firebase("https://"+(o.firebase||f.firebase||"webrtc-experiment")+".firebaseIO.com/"+f.channel).once("value",function(e){console.debug("room is present?",null!==e.val()),f.openNewSession(null===e.val())})):f.openNewSession(!1,!0))};var d=!!navigator.mozGetUserMedia,u=!(d&&!navigator.mozGetUserMedia||!d&&!navigator.webkitGetUserMedia),l=n(),f=navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i),h=!!navigator.webkitGetUserMedia,m=!!navigator.mozGetUserMedia,p=50;h&&(p=navigator.mozGetUserMedia?0:parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]));var g;i(function(e){window.iceServers=e});var v={DataURLToBlob:function(e,n,o){function t(){var e=URL.createObjectURL(new Blob(['function getBlob(_dataURL, _fileType) {var binary = atob(_dataURL.substr(_dataURL.indexOf(",") + 1)),i = binary.length,view = new Uint8Array(i);while (i--) {view[i] = binary.charCodeAt(i);};postMessage(new Blob([view], {type: _fileType}));};this.onmessage =  function (e) {var data = JSON.parse(e.data); getBlob(data.dataURL, data.fileType);}'],{type:"application/javascript"})),n=new Worker(e);return URL.revokeObjectURL(e),n}if(window.Worker&&!f){var i=t();i.onmessage=function(e){o(e.data)},i.postMessage(JSON.stringify({dataURL:e,fileType:n}))}else{for(var r=atob(e.substr(e.indexOf(",")+1)),s=r.length,a=new Uint8Array(s);s--;)a[s]=r.charCodeAt(s);o(new Blob([a]))}}},k={SaveToDisk:function(e,n){var o=document.createElement("a");o.href=e,o.target="_blank",o.download=n||e;var t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});o.dispatchEvent(t),(window.URL||window.webkitURL).revokeObjectURL(o.href)}},w={send:function(e){function o(){var e=URL.createObjectURL(new Blob(["function readFile(_file) {postMessage(new FileReaderSync().readAsDataURL(_file));};this.onmessage =  function (e) {readFile(e.data);}"],{type:"application/javascript"})),n=new Worker(e);return URL.revokeObjectURL(e),n}function t(e,n){var o={type:"file",uuid:a.uuid,maxChunks:u,currentPosition:u-l,name:a.name,fileType:a.type,size:a.size};e&&(n=e,u=l=o.packets=parseInt(n.length/c),a.maxChunks=o.maxChunks=u,o.currentPosition=u-l,i.onFileSent&&i.onFileSent(a)),i.onFileProgress&&i.onFileProgress({remaining:l--,length:u,sent:u-l,maxChunks:u,uuid:a.uuid,currentPosition:u-l},a.uuid),n.length>c?o.message=n.slice(0,c):(o.message=n,o.last=!0,o.name=a.name,a.url=URL.createObjectURL(a),i.onFileSent(a,a.uuid)),r.send(o,s),d=n.slice(o.message.length),d.length&&setTimeout(function(){t(null,d)},i.chunkInterval||100)}var i=e.root,r=e.channel,s=e._channel,a=e.file;if(!e.file)return void console.error("You must attach/select a file.");var c=15e3;i.chunkSize&&(c=i.chunkSize);var d="",u=0,l=0;if(a.uuid=n(),window.Worker&&!f){var h=o();h.onmessage=function(e){t(e.data)},h.postMessage(a)}else{var m=new FileReader;m.onload=function(e){t(e.target.result)},m.readAsDataURL(a)}}},T={send:function(e){function o(e,n){var s={type:"text",uuid:u,sendingTime:l};e&&(n=e,s.packets=parseInt(n.length/a)),n.length>a?s.message=n.slice(0,a):(s.message=n,s.last=!0,s.isobject=d),i.send(s,r),c=n.slice(s.message.length),c.length&&setTimeout(function(){o(null,c)},t.chunkInterval||100)}var t=e.root,i=e.channel,r=e._channel,s=e.text,a=t.chunkSize||1e3,c="",d=!1;"string"!=typeof s&&(d=!0,s=JSON.stringify(s));var u=n(),l=(new Date).getTime();o(s)}}}();